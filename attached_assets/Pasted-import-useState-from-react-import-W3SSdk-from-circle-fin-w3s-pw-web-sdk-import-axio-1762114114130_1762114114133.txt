import { useState } from "react";
import { W3SSdk } from "@circle-fin/w3s-pw-web-sdk";
import axios from "axios"; // For calling our backend

// --- Your App ID is included ---
const CIRCLE_APP_ID = "502da187-5a8a-53c5-9856-3d9a9ac6dd56";

// This is your backend server's URL (from Phase 2)
const BACKEND_URL = "http://localhost:3001";

// Initialize the Circle Frontend SDK
let sdk;
if (typeof window !== "undefined") {
  sdk = new W3SSdk({
    appSettings: { appId: CIRCLE_APP_ID },
  });
}

function App() {
  // --- State Variables ---
  const [userToken, setUserToken] = useState(null);
  const [encryptionKey, setEncryptionKey] = useState(null);
  const [hasPin, setHasPin] = useState(false);
  const [wallet, setWallet] = useState(null);
  const [status, setStatus] = useState("Not Authenticated");

  // --- 1. Authenticate the User ---
  async function handleAuth() {
    setStatus("Authenticating...");
    try {
      const { data } = await axios.post(`${BACKEND_URL}/auth`);
      setUserToken(data.userToken);
      setEncryptionKey(data.encryptionKey);
      
      sdk.setAuthentication({
        userToken: data.userToken,
        encryptionKey: data.encryptionKey,
      });
      
      setStatus("Authenticated. Ready to set PIN.");
    } catch (e) {
      console.error(e);
      setStatus("Authentication failed.");
    }
  }

  // --- 2. Set the User's PIN ---
  async function handleSetPin() {
    setStatus("Setting PIN... Check for UI popup.");
    try {
      const { data: challenge } = await axios.post(`${BACKEND_URL}/initiate-pin`, {
        userToken,
      });

      // This triggers the Circle UI (e.g., set PIN, security)
      sdk.execute(challenge.challengeId, (error, result) => {
        if (error) {
          setStatus(`PIN setup failed: ${error.message}`);
          return;
        }
        if (result) {
          setStatus("PIN setup complete! Ready to create wallet.");
          setHasPin(true); // Mark PIN as complete
        }
      });
    } catch (e) {
      console.error(e);
      setStatus("PIN setup request failed.");
    }
  }

  // --- 3. Create the Wallet ---
  async function handleCreateWallet() {
    setStatus("Creating wallet...");
    try {
      const { data } = await axios.post(`${BACKEND_URL}/create-wallet`, {
        userToken,
      });
      
      // --- THIS IS THE FIX ---
      // The backend response is { wallet: { ... } }. 
      // We need to get the actual wallet object *inside* it.
      const actualWallet = data.wallet;
      setStatus(`Wallet created! Address: ${actualWallet.address}`);
      setWallet(actualWallet); // Set state to the *actual* wallet
      // --- END OF FIX ---

    } catch (e) {
      console.error(e);
      setStatus("Wallet creation request failed.");
    }
  }
  
  // --- 4. The AI Agent Action ---
  async function handleSchedulePayment() {
    const aiData = {
      recipient: "0x1234567890123456789012345678901234567890", 
      amount: "0.01",
      releaseDate: "2025-11-05" // This field is no longer used but is harmless
    };
    
    setStatus("Agent: Scheduling payment... Check for confirmation UI.");
    
    try {
      // This will now work because 'wallet.id' is correct.
      const { data: challenge } = await axios.post(`${BACKEND_URL}/schedule-payment`, {
        userToken,
        walletId: wallet.id,
        recipient: aiData.recipient,
        amount: aiData.amount,
      });

      sdk.execute(challenge.challengeId, (error, result) => {
        if (error) {
          setStatus(`Payment failed: ${error.message}`);
          return;
        }
        if (result) {
          setStatus(`Payment Scheduled! Tx Hash: ${result.data.txHash}`);
          console.log(result);
        }
      });
    } catch (e) {
      console.error(e);
      setStatus("Payment scheduling request failed.");
    }
  }

  // --- The User Interface ---
  return (
    <main className="p-8 max-w-xl mx-auto space-y-4 font-sans">
      <h1 className="text-2xl font-bold">G-Wallet (Circle Edition)</h1>
      <p className="p-3 bg-gray-100 rounded-lg text-sm text-gray-700">
        <span className="font-bold">Status:</span> {status}
      </p>

      {!userToken && (
        <button 
          onClick={handleAuth} 
          className="w-full p-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all"
        >
          1. Sign Up / Log In
        </button>
      )}

      {userToken && !hasPin && (
        <button 
          onClick={handleSetPin} 
          className="w-full p-3 bg-cyan-600 text-white rounded-lg font-semibold hover:bg-cyan-700 transition-all"
        >
          2. Set Your PIN
        </button>
      )}

      {userToken && hasPin && !wallet && (
        <button 
          onClick={handleCreateWallet} 
          className="w-full p-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-all"
        >
          3. Create Your Arc Testnet Wallet
        </button>
      )}

      {wallet && (
        <div className="p-4 border rounded-lg space-y-4">
          <h2 className="text-lg font-semibold">âœ… Wallet Ready</h2>
          <p className="text-sm break-all">
            <span className="font-bold">Address:</span> {wallet.address}
          </p>
          <p className="text-sm">
            <span className="font-bold">Chain:</span> {wallet.blockchain}
          </p>
          
          <button 
            onClick={handleSchedulePayment} 
            className="w-full p-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-all"
          >
            4. (AI Agent) Send $0.01 Payment
          </button>
        </div>
      )}
    </main>
  );
}

export default App;