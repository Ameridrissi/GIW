const express = require("express");
const cors = require("cors");
require("dotenv").config();
const { 
  initiateUserControlledWalletsClient 
} = require("@circle-fin/user-controlled-wallets");

// --- ⬇️ CONFIGURATION ⬇️ ---
const ARC_TESTNET_BLOCKCHAIN_ID = "ARC-TESTNET";
const USDC_TOKEN_ID = "3362629b-8e2b-571c-99f5-17730a8f5f14";

const app = express();
app.use(cors());
app.use(express.json());

// --- ⬇️ THIS IS THE FIX ⬇️ ---
// Initialize the SDK *synchronously* (no 'await'). This is the correct way.
const circleUserSdk = initiateUserControlledWalletsClient({
  apiKey: process.env.CIRCLE_API_KEY,
});
// --- ⬆️ END OF FIX ⬆️ ---


/**
 * ENDPOINT 1: /auth
 */
app.post("/auth", async (req, res) => {
  const userId = `g-wallet-user-${Date.now()}`; 
  try {
    await circleUserSdk.createUser({ userId });
    const { data } = await circleUserSdk.createUserToken({ userId });
    console.log("Auth success, sending userToken to frontend.");
    res.json(data); 
  } catch (error) {
    console.error("Error in /auth:", error.response?.data || error.message, error.stack);
    res.status(500).json({ message: "Auth failed" });
  }
});

/**
 * ENDPOINT 2: /initiate-pin
 */
app.post("/initiate-pin", async (req, res) => {
  const { userToken } = req.body;
  try {
    const { data } = await circleUserSdk.createUserPin({
      userToken,
    });
    console.log("PIN setup initiated, sending challengeId to frontend.");
    res.json(data);
  } catch (error) {
    console.error("Error in /initiate-pin:", error.response?.data || error.message, error.stack);
    res.status(500).json({ message: "PIN setup failed" });
  }
});

/**
 * ENDPOINT 3: /create-wallet
 */
app.post("/create-wallet", async (req, res) => {
  const { userToken } = req.body;
  try {
    const { data } = await circleUserSdk.createWallet({
      userToken,
      blockchains: [ARC_TESTNET_BLOCKCHAIN_ID],
      accountType: "SCA", 
    });
    console.log("Wallet creation successful.");
    res.json(data);
  } catch (error) {
    console.error("Error in /create-wallet:", error.response?.data || error.message, error.stack);
    res.status(500).json({ message: "Wallet creation failed" });
  }
});

/**
 * ENDPOINT 4: /schedule-payment (NOW FIXED)
 */
app.post("/schedule-payment", async (req, res) => {
  const { userToken, walletId, recipient, amount } = req.body;
  
  console.log("Creating SIMPLE transfer transaction...");

  try {
    // --- THIS IS THE REAL, CORRECT FUNCTION AND PARAMETERS ---
    const { data } = await circleUserSdk.createTransaction({
      userToken,
      walletId,
      destinationAddress: recipient,
      amounts: [amount], // Must be an array
      tokenId: USDC_TOKEN_ID,
      // THIS IS THE FIX. It must be a 'fee' object.
      fee: {
        type: "level",
        config: {
          feeLevel: "MEDIUM"
        }
      }
    });

    console.log("Simple transfer challenge created, sending to frontend.");
    res.json(data); // This data contains the challengeId

  } catch (error) {
    console.error(
      "Error in /schedule-payment (transfer):",
      error.response?.data || error.message,
      error.stack
    );
    res.status(500).json({ message: "Scheduling (transfer) failed" });
  }
});

// The port is 3001
app.listen(3001, () => {
  console.log("✅ G-Wallet Backend Server is running on http://localhost:3001");
});